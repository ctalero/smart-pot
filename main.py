smile = bytearray(b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x7f\xfe\x00\x00\x00\x00\x00\x03\xff\xff\xc0\x00\x00\x00\x00\x1f\xff\xff\xf8\x00\x00\x00\x00\x7f\xff\xff\xfe\x00\x00\x00\x00\xff\xff\xff\xff\x00\x00\x00\x03\xff\xff\xff\xff\xc0\x00\x00\x07\xff\xff\xff\xff\xe0\x00\x00\x1f\xff\xff\xff\xff\xf8\x00\x00\x3f\xff\xff\xff\xff\xfc\x00\x00\x7f\xff\xff\xff\xff\xfe\x00\x00\xff\xff\xff\xff\xff\xff\x00\x00\xff\xff\xff\xff\xff\xff\x00\x01\xff\xff\xff\xff\xff\xff\x80\x03\xff\xff\xff\xff\xff\xff\xc0\x03\xff\xff\xff\xff\xff\xff\xc0\x07\xff\xff\xff\xff\xff\xff\xe0\x0f\xff\xff\xff\xff\xff\xff\xf0\x0f\xff\xff\xff\xff\xff\xff\xf0\x1f\xff\xff\xff\xff\xff\xff\xf8\x1f\xff\xff\xff\xff\xff\xff\xf8\x1f\xff\xfe\xff\xff\xff\xff\xf8\x3f\xff\xfc\x3f\xfe\x1f\xff\xfc\x3f\xff\xf8\x3f\xfc\x1f\xff\xfc\x3f\xff\xf8\x1f\xfc\x0f\xff\xfc\x7f\xff\xf0\x1f\xf8\x0f\xff\xfe\x7f\xff\xf0\x1f\xf8\x0f\xff\xfe\x7f\xff\xf8\x1f\xfc\x0f\xff\xfe\x7f\xff\xf8\x3f\xfc\x1f\xff\xfe\x7f\xff\xfc\x3f\xfe\x1f\xff\xfe\x7f\xff\xff\xff\xff\xff\xff\xfe\x7f\xff\xff\xff\xff\xff\xff\xfe\x7f\xff\xff\xff\xff\xff\xff\xfe\x7f\xff\xff\xff\xff\xff\xff\xfe\x7f\xff\xff\xff\xff\xff\xff\xfe\x7f\xff\xff\xff\xff\xff\xff\xfe\x7f\xe0\x7f\xff\xff\xff\xc7\xfe\x7f\xe0\x00\x7f\xff\xf0\x07\xfe\x7f\xe0\x00\x00\x00\x00\x07\xfe\x3f\xe0\x00\x00\x00\x00\x0f\xfc\x3f\xf0\x00\x00\x00\x00\x0f\xfc\x3f\xf0\x00\x00\x00\x00\x0f\xfc\x1f\xf0\x00\x00\x00\x00\x0f\xf8\x1f\xf8\x00\x00\x00\x00\x1f\xf8\x1f\xf8\x00\x00\x00\x00\x1f\xf8\x0f\xfc\x00\x00\x00\x00\x3f\xf0\x0f\xfc\x00\x00\x00\x00\x3f\xf0\x07\xfe\x00\x00\x00\x00\x7f\xe0\x03\xff\x00\x00\x00\x00\x7f\xc0\x03\xff\x80\x00\x00\x00\xff\xc0\x01\xff\xc0\x00\x00\x01\xff\x80\x00\xff\xe0\x00\x00\x03\xff\x00\x00\xff\xf0\x00\x00\x0f\xff\x00\x00\x7f\xfc\x00\x00\x1f\xfe\x00\x00\x3f\xff\x00\x00\x7f\xfc\x00\x00\x1f\xff\xe0\x03\xff\xf8\x00\x00\x07\xff\xff\xff\xff\xe0\x00\x00\x03\xff\xff\xff\xff\xc0\x00\x00\x00\xff\xff\xff\xff\x00\x00\x00\x00\x7f\xff\xff\xfe\x00\x00\x00\x00\x1f\xff\xff\xf8\x00\x00\x00\x00\x03\xff\xff\xc0\x00\x00\x00\x00\x00\x7f\xfe\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00')
water = bytearray(b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x80\x00\x00\x00\x00\x00\x00\x01\x80\x00\x00\x00\x00\x00\x00\x03\xc0\x00\x00\x00\x00\x00\x00\x07\xe0\x00\x00\x00\x00\x00\x00\x07\xe0\x00\x00\x00\x00\x00\x00\x0f\xf0\x00\x00\x00\x00\x00\x00\x1f\xf8\x00\x00\x00\x00\x00\x00\x1f\xf8\x00\x00\x00\x00\x00\x00\x3f\xfc\x00\x00\x00\x00\x00\x00\x7f\xfe\x00\x00\x00\x00\x00\x00\x7f\xfe\x00\x00\x00\x00\x00\x00\xff\xff\x00\x00\x00\x00\x00\x00\xff\xff\x00\x00\x00\x00\x00\x01\xff\xff\x80\x00\x00\x00\x00\x01\xff\xff\xc0\x00\x00\x00\x00\x03\xff\xff\xc0\x00\x00\x00\x00\x03\xff\xff\xc0\x00\x00\x00\x00\x07\xff\xff\xe0\x00\x00\x00\x00\x07\xff\xff\xe0\x00\x00\x00\x00\x07\xff\xff\xf0\x00\x00\x00\x00\x0f\xff\xff\xf0\x00\x00\x00\x00\x0f\xff\xff\xf0\x00\x00\x00\x00\x0f\xff\xff\xf0\x00\x00\x00\x00\x0f\xff\xff\xf0\x00\x00\x00\x00\x0f\xff\xff\xf0\x00\x00\x00\x00\x0f\xff\xff\xf0\x00\x00\x00\x00\x0f\xff\xff\xf0\x00\x00\x00\x00\x07\xff\xff\xe0\x00\x00\x00\x00\x07\xff\xff\xe0\x00\x00\x00\x00\x07\xff\xff\xe0\x00\x00\x00\x00\x03\xff\xff\xc0\x00\x00\x00\x00\x01\xff\xff\xc0\x00\x00\x00\x00\x01\xff\xff\x80\x00\x00\x00\x00\x00\x7f\xff\x00\x00\x00\x00\x00\x00\x3f\xfc\x00\x00\x00\x00\x00\x00\x0f\xf0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00')
fire = bytearray(b'\x00\x00\x00\x00\x00\x18\x00\x00\x00\x00\x00\x00\x01\xf0\x00\x00\x00\x00\x00\x00\x0f\xf0\x00\x00\x00\x00\x00\x00\x3f\xf0\x00\x00\x00\x00\x00\x00\xff\xe0\x00\x00\x00\x00\x00\x03\xff\xe0\x00\x00\x00\x00\x00\x0f\xff\xe0\x00\x00\x00\x00\x00\x3f\xff\xe0\x00\x00\x00\x00\x00\x7f\xff\xe0\x00\x00\x00\x00\x00\xff\xff\xe0\x00\x00\x00\x00\x01\xff\xff\xe0\x00\x00\x00\x00\x03\xff\xff\xe0\x00\x00\x00\x00\x07\xff\xff\xf0\x00\x00\x00\x00\x0f\xff\xff\xf0\x00\x00\x00\x00\x0f\xff\xff\xf0\x00\x00\x00\x00\x1f\xff\xff\xf8\x00\x00\x00\x00\x3f\xff\xff\xf8\x00\x00\x00\x00\x3f\xff\xff\xfc\x00\x00\x00\x00\x7f\xff\xff\xfc\x00\x00\x00\x00\x7f\xff\xff\xfe\x00\x00\x00\x00\x7f\xff\xff\xfe\x00\x00\x00\x00\xff\xff\xff\xff\x00\x00\x00\x08\xff\xff\xff\xff\x00\x00\x00\x18\xff\xff\xff\xff\x80\x00\x00\x3c\xff\xff\xff\xff\x80\x00\x00\x7c\xff\xff\xff\xff\x80\x00\x00\x7e\xff\xff\xff\xff\xc1\x80\x00\xff\xff\xff\xff\xff\xc3\x80\x01\xff\xff\xfc\xff\xff\xc7\x80\x01\xff\xff\xfc\xff\xff\xef\x80\x03\xff\xff\xf8\xff\xff\xef\xc0\x03\xff\xff\xf8\xff\xff\xff\xe0\x07\xff\xff\xf0\xff\xff\xff\xf0\x07\xff\xff\xe0\xff\xff\xff\xf8\x0f\xff\xff\xe0\xff\xff\xff\xf8\x0f\xff\xff\xe0\xff\xff\xff\xfc\x0f\xff\xff\xc0\xff\xff\xff\xfe\x0f\xff\xff\xc0\x7f\xff\xff\xfe\x0f\xff\xff\xc0\x7f\xff\xff\xfe\x1f\xff\xff\x80\x3f\xff\xff\xfe\x1f\xff\xff\x80\x1f\xff\xff\xfe\x1f\xff\xff\x80\x0f\xff\xff\xfe\x0f\xff\xff\x80\x07\xff\xff\xfe\x0f\xff\xff\x80\x03\xff\xff\xfe\x0f\xff\xff\x80\x01\xff\xff\xfc\x8f\xff\xff\xc0\x00\xff\xff\xfc\x47\xff\xff\xc0\x00\x3f\xff\xf8\x7f\xff\xfc\xc0\x00\x1f\xff\xf0\x7f\xff\xfc\x40\x00\x0f\xff\xe2\x3f\xff\xf8\x60\x00\x0f\xff\xc6\x1f\xff\xf8\x20\x00\x07\xff\x9c\x1f\xff\xf8\x00\x00\x07\xff\x78\x0f\xff\xf0\x00\x00\x07\xff\xf0\x07\xff\xf0\x00\x00\x07\xff\xf0\x07\xff\xf0\x00\x00\x07\xff\xe0\x03\xff\xf0\x00\x00\x07\xff\x80\x01\xff\xf0\x00\x00\x07\xff\x00\x00\xff\xf0\x00\x00\x0f\xfe\x00\x00\x3f\xf0\x00\x00\x1f\xf8\x00\x00\x1f\xf8\x00\x00\x1f\xe0\x00\x00\x07\xfc\x00\x00\x3f\x80\x00\x00\x00\xfe\x00\x00\x7c\x00\x00\x00\x00\x1f\x80\x00\x60\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00')
sun = bytearray(b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x03\x00\x00\x00\x00\x00\x00\x04\x03\x00\x00\x00\x00\x00\x00\x06\x03\x80\x80\x00\x00\x00\x00\x07\x07\x83\x80\x00\x00\x00\x00\x07\x87\xc7\x80\x00\x00\x00\x00\x07\xcf\xc7\x80\x00\x00\x00\x00\x07\x8f\xc7\x80\x00\x00\x00\x00\x01\x80\x03\x00\x00\x00\x00\x07\x80\x00\x00\x00\x00\x00\x00\x03\xf0\x00\x00\x00\x00\x00\x00\x01\xfc\x1f\xe0\x00\x00\x00\x00\x01\xf8\x7f\xf0\x00\x00\x00\x00\x00\xf1\xff\xe0\x00\x00\x00\x00\x00\xe3\xff\xc0\x00\x00\x00\x00\x00\x43\xff\x80\x00\x00\x00\x00\x00\x07\xff\x00\x00\x00\x00\x00\x3e\x0f\xfe\x00\x01\xf8\x00\x00\x7f\x0f\xfc\x00\x01\xf8\x00\x00\x1f\x1f\xf8\x00\x21\xf0\x00\x00\x0e\x1f\xf0\x00\x60\xc0\x00\x00\x00\x1f\xe0\x00\xe0\x00\x00\x00\x00\x1f\xc0\x01\xe0\x00\x00\x00\x01\x1f\x80\x03\xe2\x00\x00\x00\x03\x1f\x00\x07\xe3\x80\x00\x00\x0f\x1e\x00\x0f\xe3\xc0\x00\x00\x1f\x9c\x00\x1f\xe3\xf0\x00\x00\x7f\x88\x00\x3f\xe7\xf8\x00\x00\x3f\x80\x00\x7f\xc7\xf8\x00\x00\x00\x80\x00\xff\xc4\x00\x00\x00\x00\x00\x01\xff\x80\x00\x00\x00\x00\x00\x03\xff\x00\x00\x00\x00\x00\x00\x07\xfe\x0e\x00\x00\x00\x00\x00\x0f\xfc\x1e\x00\x00\x00\x00\x00\x0f\xf0\x1f\x00\x00\x00\x00\x00\x00\x01\x8f\x00\x00\x00\x00\x00\x00\x03\x83\x80\x00\x00\x00\x00\xe0\x1f\x80\x00\x00\x00\x00\x01\xe0\x1f\x80\x00\x00\x00\x00\x03\xc3\x0f\x80\x00\x00\x00\x00\x07\x87\x87\x80\x00\x00\x00\x00\x07\x07\x83\x80\x00\x00\x00\x00\x06\x03\x80\x80\x00\x00\x00\x00\x04\x03\x00\x00\x00\x00\x00\x00\x00\x03\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00')

import machine
from machine import Pin, SoftI2C
import ssd1306
import framebuf
from machine import Pin, ADC
import dht 
import network
import urequests
import time
from time import sleep
from machine import Timer, Pin

def ftoggle():
    global toggle
    toggle = not toggle
    led.value(toggle)

def interruption_handler(pin):
    global timer_count
    timer_count += 1

a = framebuf.FrameBuffer(smile, 64, 64, framebuf.MONO_HLSB)
b = framebuf.FrameBuffer(water, 64, 64, framebuf.MONO_HLSB)
c = framebuf.FrameBuffer(fire, 64, 64, framebuf.MONO_HLSB)
d = framebuf.FrameBuffer(sun, 64, 64, framebuf.MONO_HLSB)
timer_0 = Timer(0) 
timer_count = 0 


button = machine.Pin(32, machine.Pin.IN, machine.Pin.PULL_UP)
led = Pin(25,Pin.OUT)

num = 0

led = Pin(2,Pin.OUT)
led_Temp = Pin(18,Pin.OUT)
led_HumSoil = Pin(5,Pin.OUT)
led_Light = Pin(15,Pin.OUT)
button = Pin(32,Pin.IN)
soil = ADC(Pin(35))
ldr = ADC(Pin(34))

toggle=True

sensor = dht.DHT11(Pin(4))

i2c = SoftI2C(scl=Pin(22), sda=Pin(21))

oled_width = 128
oled_height = 64
oled = ssd1306.SSD1306_I2C(oled_width, oled_height, i2c)

tempamb = '0'
humidityamb = '0'
light = '0'
humidity = '0'
ssid = 'FAMILIA_TAMAL'
password = 'yWSKv36HmR9B'

while True:

    timer_count_old = 0
    timer_0.init(mode=Timer.PERIODIC, period=1000, callback=interruption_handler)
    try:
        sleep(1)
        sensor.measure()
        tempamb = sensor.temperature()
        humidityamb = sensor.humidity()
    except:
        print("It's not possible to obtain data")
        pass
        
    m = 100
    soil.atten(ADC.ATTN_11DB)       #Full range: 3.3v
    soil.width(ADC.WIDTH_12BIT)
    ldr.atten(ADC.ATTN_11DB)       #Full range: 3.3v
    ldr.width(ADC.WIDTH_12BIT)
    min_moisture=0
    max_moisture=4095
    soil.read()
    ldr.read()
    m = (max_moisture-soil.read())*100/(max_moisture-min_moisture)
    l = (max_moisture-ldr.read())*100/(max_moisture-min_moisture)
    moisture = int(m*3)
    tempamb = sensor.temperature()
    humidityamb = sensor.humidity()
    light = int(l)
    humidity = moisture
    
    while timer_count > 1200:
        try:
            station = network.WLAN(network.STA_IF)
            station.active(True)
            station.connect(ssid, password)
            ftoggle()
            sleep(0.3)
            break
        except OSError as e:
            pass
        while station.isconnected() == False:
            ftoggle()
            sleep(0.3)
                  
        print('Connection successful')
        print(station.ifconfig())
        
        sensor_readings = {'tempAmb':tempamb, 'humAmb':humidityamb, 'light':light, 'humidity':humidity}

        request_headers = {'Content-Type': 'application/json'}

        request = urequests.post(
          'https://hooks.zapier.com/hooks/catch/16958534/3z6q5ma/',
          json=sensor_readings,
        headers=request_headers)
        print(request.text)
        request.close()
        ftoggle()
        timer_count = 0
        
    while button.value() == 0 and humidity > 30 and light > 50 and tempamb < 30:
        oled.fill(0)
        oled.blit(a, 0, 0)
        oled.text('Estado:', 64, 0)
        oled.text('Optimo', 64, 15)

        oled.show()
        time.sleep(1)
        break

    while button.value() == 0 and light < 50:
        oled.fill(0)
        oled.blit(d, 0, 0)
        oled.text('Estado:', 64, 0)
        oled.text('Poca', 64, 15)
        oled.text('Luz', 64, 25)
        oled.show()
        time.sleep(1)
        break
        
    while button.value() == 0 and humidity < 30:
        oled.fill(0)
        oled.blit(b, 0, 0)
        oled.text('Estado:', 64, 0)
        oled.text('Poca', 64, 15)
        oled.text('Agua', 64, 25)
        oled.show()
        time.sleep(1)
        break
        
    while button.value() == 0 and tempamb > 30:
        oled.fill(0)
        oled.blit(c, 0, 0)
        oled.text('Estado:', 64, 0)
        oled.text('Alta', 64, 15)
        oled.text('Temp.*C', 64, 25)
        oled.show()
        time.sleep(1)
        break
        
    while button.value() == 1:
        oled.fill(0)
        oled.text('Temp.Amb   '+str(tempamb)+'  C',0,0)
        oled.text('Hum.Amb    '+str(humidityamb)+'  %',0,10)
        oled.text('Luz.Amb    '+str(light)+'  %',0,20)
        oled.text('Hum.Planta'+str(humidity)+'  %',0,30)
        oled.show()
        time.sleep(0.1)
        break
    print(timer_count)



